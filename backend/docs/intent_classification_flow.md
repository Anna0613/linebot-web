# 意圖判斷流程說明

## 概述

本文檔說明 LINE Bot 的意圖判斷機制，包括如何使用知識庫文件列表和 AI 摘要來優化意圖判斷，避免不必要的 RAG 檢索。

---

## 流程圖

```
用戶訊息
    ↓
取得知識庫文件列表（包含 AI 摘要）
    ↓
構建完整的意圖判斷訊息
    ↓
發送給 Groq AI（llama-3.1-8b-instant）
    ↓
AI 判斷意圖（chat 或 query）
    ↓
根據意圖決定回應方式
    ├─ chat → 直接閒聊回應
    └─ query → 執行 RAG 檢索 + AI 回答
```

---

## 詳細流程

### 1. 取得知識庫文件列表

**位置**: `app/services/rag_service.py` → `get_knowledge_documents_summary()`

**功能**:
- 查詢該 Bot 的所有知識庫文件（包含 project 和 global scope）
- 只返回未刪除的文件（`deleted_at IS NULL`）
- 只包含有 AI 摘要的文件（`ai_summary IS NOT NULL`）

**返回格式**:
```python
[
    {
        "title": "營業時間說明.txt",
        "summary": "本文件說明公司的營業時間，包括平日、週末和國定假日的營業時段..."
    },
    {
        "title": "產品介紹",
        "summary": "介紹公司主要產品和服務，包括產品特色、價格、使用方式..."
    }
]
```

---

### 2. 構建意圖判斷訊息

**位置**: `app/services/rag_service.py` → `_classify_intent()`

**系統提示詞**:
```
你是一個嚴格的意圖分類器。你的任務是分析用戶訊息，判斷其核心意圖。

【輸出格式要求 - 非常重要】
你必須且僅能回答以下兩個詞之一：chat 或 query
不要加上任何標點符號、解釋、引號、括號或其他文字。
嚴格遵守格式，只輸出一個英文單詞。

【分類原則】
chat：用戶的主要目的是進行社交互動、情感交流或日常對話，不需要具體資訊或答案。
query：用戶的主要目的是獲取特定資訊、尋求解答或需要實質性的回應內容。

【知識庫文件列表判斷規則 - 最重要】
如果用戶訊息中包含【知識庫文件列表】區塊：
1. 仔細閱讀列表中每個文件的「檔案名稱」和「摘要」
2. 判斷用戶問題是否與任一文件的主題或內容相關
3. 判斷標準：
   - 如果用戶問題明確詢問文件中提到的主題、概念或資訊 → 輸出 query
   - 如果用戶問題與所有文件的主題都完全無關 → 輸出 chat
   - 如果用戶問題是閒聊、問候、情感表達等社交性質 → 輸出 chat
4. 範例說明：
   - 文件摘要提到「營業時間」，用戶問「你們週末有開嗎」→ query（相關）
   - 文件摘要提到「產品價格」，用戶問「今天天氣真好」→ chat（無關）
   - 文件摘要提到「退貨政策」，用戶問「如何退貨」→ query（相關）

如果用戶訊息中沒有【知識庫文件列表】區塊：
- 按照一般分類原則判斷（閒聊 → chat，查詢資訊 → query）

請根據以上規則進行判斷，只輸出 chat 或 query。
```

**用戶訊息格式**（有知識庫文件時）:
```
【知識庫文件列表】
以下是系統中已有的知識庫文件及其摘要：

1. 營業時間說明.txt
   摘要：本文件說明公司的營業時間，包括平日、週末和國定假日的營業時段...

2. 產品介紹
   摘要：介紹公司主要產品和服務，包括產品特色、價格、使用方式...

【知識庫文件列表結束】

【用戶問題】
你們週末有開嗎？
```

---

### 3. AI 判斷意圖

**使用模型**: `llama-3.1-8b-instant`

**參數設定**:
- `temperature`: 0.0（確定性輸出）
- `max_tokens`: 10（只需要輸出 "chat" 或 "query"）
- `top_p`: 1.0（確定性採樣）

**預期輸出**:
- `chat`：閒聊模式
- `query`：查詢模式

---

### 4. 意圖判斷結果處理

**位置**: `app/services/rag_service.py` → `_classify_intent()`

**處理邏輯**:
1. 清理 AI 回應（移除空白、標點符號、引號等）
2. 嚴格匹配 "chat" 或 "query"
3. 容錯處理：如果包含關鍵詞但格式不標準，仍然接受
4. 完全無法識別時，預設為 "query"（保守策略）

**日誌輸出**:
```
📋 意圖判斷 - 發送給 AI 的完整訊息：
============================================================
【系統提示詞】
你是一個嚴格的意圖分類器...
============================================================
【用戶訊息（包含知識庫文件列表）】
【知識庫文件列表】
...
【用戶問題】
你們週末有開嗎？
============================================================

🔍 意圖判斷 API 回應：
   模型: llama-3.1-8b-instant
   用戶問題: '你們週末有開嗎？'
   AI 回應: query

✅ 意圖判斷結果: 查詢 (原始回應: 'query')
```

---

## 關鍵優化點

### 1. 知識庫文件列表的作用

**目的**: 讓 AI 知道系統中有哪些知識庫文件，避免對無關問題執行 RAG 檢索。

**範例**:
- **有知識庫文件列表**:
  - 文件: "營業時間說明"
  - 用戶問: "你們週末有開嗎？" → AI 判斷為 `query`（相關）
  - 用戶問: "今天天氣真好" → AI 判斷為 `chat`（無關）

- **無知識庫文件列表**:
  - 用戶問: "你們週末有開嗎？" → AI 可能判斷為 `query`（因為是問題）
  - 用戶問: "今天天氣真好" → AI 判斷為 `chat`（閒聊）

### 2. AI 摘要的重要性

**摘要長度**: 100-200 字

**摘要要求**:
- 使用繁體中文
- 簡潔明確，涵蓋文件核心內容
- 足以讓人理解文件主題和重點
- 不使用 Markdown 格式

**範例**:
```
【檔案】營業時間說明.txt
【摘要】本文件說明公司的營業時間，包括平日（週一至週五）9:00-18:00，
週末（週六）10:00-17:00，週日及國定假日休息。特殊節日營業時間另行公告。
如有緊急需求，可透過客服專線聯繫。
```

### 3. 意圖判斷的準確性

**提升準確性的方法**:
1. ✅ 提供清晰的系統提示詞
2. ✅ 包含知識庫文件列表和摘要
3. ✅ 使用具體的判斷範例
4. ✅ 設定 temperature=0.0 確保確定性輸出
5. ✅ 實作容錯處理機制

---

## 測試方法

### 使用測試腳本

```bash
cd linebot-web/backend
python scripts/test_intent_classification.py
```

**測試案例**:
1. 簡單問候（預期: chat）
2. 閒聊天氣（預期: chat）
3. 詢問營業時間（預期: query，假設知識庫有相關文件）
4. 詢問退貨政策（預期: query，假設知識庫有相關文件）
5. 詢問身份（預期: chat）

### 查看日誌

**啟用詳細日誌**:
```python
import logging
logging.basicConfig(level=logging.INFO)
```

**關鍵日誌**:
- `📋 意圖判斷 - 發送給 AI 的完整訊息`：查看 AI 收到的完整內容
- `🔍 意圖判斷 API 回應`：查看 AI 的回應
- `✅ 意圖判斷結果`：查看最終判斷結果

---

## 常見問題

### Q1: AI 總是判斷為 query，即使是閒聊？

**可能原因**:
- 知識庫文件列表沒有正確傳遞給 AI
- 系統提示詞不夠清楚

**解決方法**:
1. 檢查日誌，確認 AI 收到的訊息包含知識庫文件列表
2. 檢查 `get_knowledge_documents_summary()` 是否正確返回文件列表
3. 確認文件有 AI 摘要（`ai_summary IS NOT NULL`）

### Q2: AI 總是判斷為 chat，即使問題與知識庫相關？

**可能原因**:
- AI 摘要不夠詳細，無法涵蓋文件核心內容
- 用戶問題的表達方式與摘要內容差異太大

**解決方法**:
1. 檢查 AI 摘要的品質，確保涵蓋文件核心內容
2. 優化摘要生成的系統提示詞
3. 增加摘要長度（目前 100-200 字）

### Q3: 如何調整意圖判斷的敏感度？

**方法**:
1. 修改系統提示詞中的判斷標準
2. 調整 `temperature` 參數（目前 0.0）
3. 修改容錯處理邏輯

---

## 相關檔案

- `app/services/rag_service.py`：意圖判斷主邏輯
- `app/services/groq_service.py`：AI 摘要生成
- `app/services/knowledge_processing_service.py`：文件處理和摘要生成
- `app/models/knowledge.py`：知識庫資料模型
- `scripts/test_intent_classification.py`：測試腳本

---

## 更新日誌

- **2025-10-24**: 初版文檔
  - 實作知識庫文件列表和 AI 摘要功能
  - 優化意圖判斷系統提示詞
  - 加強日誌輸出
  - 創建測試腳本

